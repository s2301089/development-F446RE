/*
 * USART_Arduino.c
 *
 *  Created on: Mar 3, 2025
 *      Author: Mitsu
 */

#include "USART_Arduino.h"
#include <stdbool.h>
#include <stdio.h>

int getData(UART_HandleTypeDef* huart,getdata revdata){
	uint8_t Rdata[REV_SIZE] = {};
	if(RevAF(huart) == 0xaf){
		AddArray(huart,Rdata);
	}
}

uint8_t RevAF(UART_HandleTypeDef* huart){
	static int timeout;
	uint8_t Gdata;
	HAL_StatusTypeDef status;
	status = HAL_UART_Receive(huart, &Gdata, 1, WAIT);
	if(status == HAL_OK){
		if(Gdata == 0xaf){
			return Gdata;
		}else{
			printf("not 0xaf\r\n");
			return 0x00;
		}
	}else {
		timeout++;
		printf("else %2d\r\n",timeout);
		if(timeout >= TIMEOUT_MAX){
			printf("timeout\r\n");
			timeout = 0;
		}
		return 0xff;
	}
}

void AddArray(UART_HandleTypeDef* huart,uint8_t* Adata){
	uint8_t Gdata;
	HAL_StatusTypeDef status;
	Adata[0] = 0xaf;

	for(int i = 1;i < REV_SIZE;i++){
		status = HAL_UART_Receive(huart, &Gdata, 1, WAIT);
		if(status == HAL_OK){
			Adata[i] = Gdata;
		}else {
			i--;
		}
	}

	return;
}

